<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>스코어 입력 - 디버깅</title>
<style>
    /* --- 동일한 CSS 스타일 --- */
    body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; }
    .section { margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type="text"] { width: calc(50% - 12px); padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; display: inline-block; }
    input[type="text"]:first-of-type { margin-right: 5px; }
    .team-inputs label { margin-bottom: 5px; }
    .button-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .button-group button { padding: 8px 12px; font-size: 16px; cursor: pointer; }
    .score-controls { display: flex; align-items: center; gap: 5px; }
    .score-label { font-weight: bold; min-width: 60px; text-align: right; margin-right: 3px; }
    .score-controls span[id^="score"] { font-weight: bold; font-size: 1.2em; min-width: 20px; text-align: center; padding: 0 5px; background-color: #eee; border-radius: 3px; }
    .checkbox-group label { margin-right: 10px; cursor: pointer; }
    .status-alert { animation: flash 0.4s ease-in-out 2; }
    @keyframes flash { 0%, 100% { background-color: transparent; } 50% { background-color: yellow; } }
     #ball_status, #strike_status, #out_status, #inning_status { margin-top: 5px; font-weight: bold; padding: 5px; background-color: #e9e9e9; border-radius: 4px; }
     #out_status span { display: inline-block; width: 12px; height: 12px; margin: 0 2px; border-radius: 50%; vertical-align: middle; }
</style>
</head>
<body>
<h1>스코어보드 입력 - 디버깅</h1>
<div class="section team-inputs">
<label>팀명</label>
<input id="team1" placeholder="팀1 이름" type="text"/>
<input id="team2" placeholder="팀2 이름" type="text"/>
</div>
<div class="section">
<label>점수 조정</label>
<div class="button-group">
<div class="score-controls">
<span class="score1-label score-label">팀1</span>:
          <button id="btn-score1-plus">+</button>
<span id="score1">0</span>
<button id="btn-score1-minus">-</button>
</div>
<span> | </span>
<div class="score-controls">
<span class="score2-label score-label">팀2</span>:
          <button id="btn-score2-plus">+</button>
<span id="score2">0</span>
<button id="btn-score2-minus">-</button>
</div>
</div>
<button id="reset-score">점수 리셋</button>
</div>
<div class="section">
<label>볼카운트</label>
<div class="button-group">
<span>B:</span><button id="btn-ball-plus">+</button><button id="btn-ball-minus">-</button>
<span>S:</span><button id="btn-strike-plus">+</button><button id="btn-strike-minus">-</button>
<span>O:</span><button id="btn-out-plus">+</button><button id="btn-out-minus">-</button>
</div>
<div id="ball_status">볼: 0</div>
<div id="strike_status">스트라이크: 0</div>
<div id="out_status">아웃: </div>
<button id="reset-counts">카운트 리셋</button>
</div>
<div class="section">
<label>이닝</label>
<div class="button-group">
<button id="btn-inning-minus">-</button><span id="inning_status">1회초</span><button id="btn-inning-plus">+</button>
</div>
<button id="reset-inning">이닝 리셋</button>
</div>
<div class="section">
<label>주루상황</label>
<div class="checkbox-group">
<label><input id="base1" type="checkbox"/> 1루</label>
<label><input id="base2" type="checkbox"/> 2루</label>
<label><input id="base3" type="checkbox"/> 3루</label>
</div>
<button id="reset-bases">주루 리셋</button>
</div>
<script>
  let ws;

  // --- 상태 변수 ---
  let ballCount = 0;
  let strikeCount = 0;
  let outCount = 0;
  let inningNum = 1;
  let isTop = true; // true: 초, false: 말

  // --- 웹소켓 연결 및 함수 ---
  function connectWebSocket() {
      ws = new WebSocket("ws://" + location.hostname + ":8765");

      ws.onopen = () => {
          console.log("✅ WebSocket 연결됨");
          sendInitialState();
      };

      ws.onmessage = (event) => {
          // 입력 페이지이므로 수신 메시지 처리 안 함
      };

      ws.onerror = (error) => {
          console.error("❌ WebSocket 오류:", error);
      };

      ws.onclose = () => {
          console.log("🔌 WebSocket 연결 끊김. 5초 후 재연결 시도...");
          setTimeout(connectWebSocket, 5000);
      };
  }

  function send(type, value) {
    if (ws && ws.readyState === WebSocket.OPEN) {
      const data = { type, value };
      console.log("📤 전송:", data);
      ws.send(JSON.stringify(data));
    } else {
      console.warn("WebSocket이 연결되지 않아 전송 실패:", { type, value });
    }
  }

  // --- UI 업데이트 및 데이터 전송 함수 ---

  function flashElement(element) {
      if (element) {
          element.classList.add("status-alert");
          setTimeout(() => element.classList.remove("status-alert"), 400);
      }
  }

  function updateTeamLabel() {
    const team1Name = document.getElementById("team1")?.value || "팀1";
    const team2Name = document.getElementById("team2")?.value || "팀2";
    document.querySelectorAll(".score1-label").forEach(el => el.textContent = team1Name);
    document.querySelectorAll(".score2-label").forEach(el => el.textContent = team2Name);
    send("team1", team1Name);
    send("team2", team2Name);
  }

  function adjustScore(teamId, delta) {
    const el = document.getElementById(teamId);
    if (!el) return;
    let current = parseInt(el.textContent || "0", 10);
    const updated = Math.max(0, current + delta);
    el.textContent = updated.toString();
    send(teamId, updated);
  }

  function updateBallDisplay() {
    const el = document.getElementById("ball_status");
    if (el) {
      el.textContent = "볼: " + ballCount;
      flashElement(el);
    }
    send("ball", ballCount);
  }

  function updateStrikeDisplay() {
    const el = document.getElementById('strike_status');
    if (el) {
      el.textContent = '스트라이크: ' + strikeCount;
      flashElement(el);
    }
    send('strike', strikeCount);
  }

  function updateOutDisplay() {
    const el = document.getElementById('out_status');
    const out1 = document.getElementById('out1');
    const out2 = document.getElementById('out2');
    if (el && out1 && out2) {
      el.ariaLabel = `아웃: ${outCount}`;
      out1.classList.toggle('active', outCount >= 1);
      out2.classList.toggle('active', outCount >= 2);
      flashElement(el);
    }
    send('out', outCount);
  }

  // --- 이닝 표시 업데이트 함수 (디버깅 로그 추가) ---
  function updateInningDisplay() {
    console.log(`updateInningDisplay 호출됨: inningNum=${inningNum}, isTop=${isTop}`); // 로그 추가
    const el = document.getElementById('inning_display');
    const inningString = `${inningNum}회${isTop ? '초' : '말'}`;
    if (el) {
      console.log(`이닝 표시 업데이트: ${inningString}`); // 로그 추가
      el.textContent = inningString;
      flashElement(el);
    } else {
      console.error("Error: 'inning_display' 요소를 찾을 수 없습니다."); // 오류 로그 추가
    }
    send('inning', inningString);
  }

  function updateBaseDisplay(baseId, isChecked) {
      send(baseId, isChecked);
  }

  // --- 카운트 및 이닝 변경 로직 ---

  function resetCounts() {
      ballCount = 0;
      strikeCount = 0;
  }

  function clearBases() {
      document.getElementById('base1').checked = false;
      document.getElementById('base2').checked = false;
      document.getElementById('base3').checked = false;
      updateBaseDisplay('base1', false);
      updateBaseDisplay('base2', false);
      updateBaseDisplay('base3', false);
  }

  function handleStrikeOut() {
      console.log("삼진!");
      outCount++;
      resetCounts();
      updateOutDisplay();
      updateBallDisplay();
      updateStrikeDisplay();
      checkThreeOuts();
  }

  function handleWalk() {
      console.log("볼넷!");
      resetCounts();
      updateBallDisplay();
      updateStrikeDisplay();
  }

  function checkThreeOuts() {
      if (outCount >= 3) {
          console.log("쓰리 아웃! 공수교대.");
          changeInning(true); // 공수교대로 인한 이닝 변경임을 표시 (true 전달)
          outCount = 0;
          resetCounts();
          clearBases();
          updateOutDisplay();
          updateBallDisplay();
          updateStrikeDisplay();
      }
  }

  // --- 이닝 변경 함수 (디버깅 로그 추가, 공수교대 파라미터 추가) ---
  function changeInning(isTurnChange = false) { // 공수교대 여부 파라미터 추가
      console.log("changeInning 호출됨", isTurnChange ? "(공수교대)" : ""); // 로그 추가
      if (isTop) { // 초 -> 말
          isTop = false;
          console.log("이닝 변경: 초 -> 말");
      } else { // 말 -> 다음 회 초
          isTop = true;
          inningNum++;
          console.log(`이닝 변경: 말 -> ${inningNum}회 초`);
      }
      // 공수교대로 인한 호출 시에는 updateInningDisplay를 checkThreeOuts에서 하므로 중복 호출 방지
      if (!isTurnChange) {
          updateInningDisplay();
      }
  }

  function previousInning() {
      console.log("previousInning 호출됨"); // 로그 추가
      if (isTop) { // 초 -> 이전 회 말
          if (inningNum > 1) {
              inningNum--;
              isTop = false;
              console.log(`이닝 변경: 초 -> ${inningNum}회 말`);
              updateInningDisplay();
          } else {
              console.log("1회초 이전으로 갈 수 없습니다.");
              return; // 변경 없음
          }
      } else { // 말 -> 현재 회 초
          isTop = true;
          console.log("이닝 변경: 말 -> 초");
          updateInningDisplay();
      }
  }

  // --- 초기 상태 전송 함수 ---
  function sendInitialState() {
      console.log("초기 상태 전송 중...");
      updateTeamLabel();
      send("score1", parseInt(document.getElementById("score1")?.textContent || "0", 10));
      send("score2", parseInt(document.getElementById("score2")?.textContent || "0", 10));
      send("ball", ballCount);
      send("strike", strikeCount);
      send("out", outCount);
      // 초기 이닝 전송 전에 updateInningDisplay를 호출하여 값 설정 및 전송
      updateInningDisplay();
      // send('inning', `${inningNum}회${isTop ? '초' : '말'}`); // updateInningDisplay에서 전송하므로 중복
      send("base1", document.getElementById("base1")?.checked || false);
      send("base2", document.getElementById("base2")?.checked || false);
      send("base3", document.getElementById("base3")?.checked || false);
  }


  // --- DOM 로드 후 실행 ---
  window.addEventListener("DOMContentLoaded", () => {
    connectWebSocket(); // 웹소켓 연결 시작

    // 초기 UI 업데이트 (0, 1회초 등)
    updateBallDisplay();
    updateStrikeDisplay();
    updateOutDisplay();
    // updateInningDisplay(); // sendInitialState에서 호출됨
    updateTeamLabel();

    // --- 이벤트 리스너 연결 ---

    // 팀명
    document.getElementById("team1")?.addEventListener("input", updateTeamLabel);
    document.getElementById("team2")?.addEventListener("input", updateTeamLabel);

    // 점수
    document.getElementById("btn-score1-plus")?.addEventListener("click", () => adjustScore("score1", 1));
    document.getElementById("btn-score1-minus")?.addEventListener("click", () => adjustScore("score1", -1));
    document.getElementById("btn-score2-plus")?.addEventListener("click", () => adjustScore("score2", 1));
    document.getElementById("btn-score2-minus")?.addEventListener("click", () => adjustScore("score2", -1));
    document.getElementById("reset-score")?.addEventListener("click", () => {
      adjustScore("score1", -parseInt(document.getElementById("score1")?.textContent || "0", 10));
      adjustScore("score2", -parseInt(document.getElementById("score2")?.textContent || "0", 10));
    });

    // 볼카운트
    document.getElementById("btn-ball-plus")?.addEventListener("click", () => {
      if (ballCount < 3) {
        ballCount++;
        updateBallDisplay();
      } else {
        ballCount = 4;
        handleWalk();
      }
    });
    document.getElementById("btn-ball-minus")?.addEventListener("click", () => {
      if (ballCount > 0) {
        ballCount--;
        updateBallDisplay();
      }
    });

    // 스트라이크 카운트
    document.getElementById("btn-strike-plus")?.addEventListener("click", () => {
        if (strikeCount < 2) {
            strikeCount++;
            updateStrikeDisplay();
        } else {
            strikeCount = 3;
            handleStrikeOut();
        }
    });
    document.getElementById("btn-strike-minus")?.addEventListener("click", () => {
        if (strikeCount > 0) {
            strikeCount--;
            updateStrikeDisplay();
        }
    });

    // 아웃 카운트
    document.getElementById("btn-out-plus")?.addEventListener("click", () => {
        if (outCount < 2) {
            outCount++;
            resetCounts();
            updateOutDisplay();
            updateBallDisplay();
            updateStrikeDisplay();
        } else if (outCount === 2) {
            outCount = 3;
            resetCounts();
            updateBallDisplay();
            updateStrikeDisplay();
            // updateOutDisplay(); // 어차피 checkThreeOuts에서 리셋 후 업데이트함
            checkThreeOuts(); // 쓰리아웃 처리 (여기서 최종 아웃 표시 업데이트)
        }
    });
    document.getElementById("btn-out-minus")?.addEventListener("click", () => {
        if (outCount > 0) {
            outCount--;
            updateOutDisplay();
        }
    });

    document.getElementById("reset-counts")?.addEventListener("click", () => {
        outCount = 0;
        resetCounts(); // B/S 리셋
        updateOutDisplay();
        updateBallDisplay();
        updateStrikeDisplay();
    });

    // --- 이닝 버튼 리스너 (changeInning/previousInning 직접 호출) ---
    document.getElementById("btn-inning-plus")?.addEventListener("click", () => changeInning()); // isTurnChange=false 기본값
    document.getElementById("btn-inning-minus")?.addEventListener("click", previousInning);

    document.getElementById("reset-inning")?.addEventListener("click", () => {
        inningNum = 1;
        isTop = true;
        console.log("이닝 리셋됨: 1회 초"); // 로그 추가
        updateInningDisplay();
    });

    // 주루상황
    document.getElementById("base1")?.addEventListener("change", (e) => updateBaseDisplay("base1", e.target.checked));
    document.getElementById("base2")?.addEventListener("change", (e) => updateBaseDisplay("base2", e.target.checked));
    document.getElementById("base3")?.addEventListener("change", (e) => updateBaseDisplay("base3", e.target.checked));
    document.getElementById("reset-bases")?.addEventListener("click", clearBases);

  }); // DOMContentLoaded 끝
</script>
</html>
