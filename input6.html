<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>ìŠ¤ì½”ì–´ ì…ë ¥ - ë””ë²„ê¹…</title>
<style>
    /* --- ë™ì¼í•œ CSS ìŠ¤íƒ€ì¼ --- */
    body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; }
    .section { margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type="text"] { width: calc(50% - 12px); padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; display: inline-block; }
    input[type="text"]:first-of-type { margin-right: 5px; }
    .team-inputs label { margin-bottom: 5px; }
    .button-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .button-group button { padding: 8px 12px; font-size: 16px; cursor: pointer; }
    .score-controls { display: flex; align-items: center; gap: 5px; }
    .score-label { font-weight: bold; min-width: 60px; text-align: right; margin-right: 3px; }
    .score-controls span[id^="score"] { font-weight: bold; font-size: 1.2em; min-width: 20px; text-align: center; padding: 0 5px; background-color: #eee; border-radius: 3px; }
    .checkbox-group label { margin-right: 10px; cursor: pointer; }
    .status-alert { animation: flash 0.4s ease-in-out 2; }
    @keyframes flash { 0%, 100% { background-color: transparent; } 50% { background-color: yellow; } }
     #ball_status, #strike_status, #out_status, #inning_status { margin-top: 5px; font-weight: bold; padding: 5px; background-color: #e9e9e9; border-radius: 4px; }
     #out_status span { display: inline-block; width: 12px; height: 12px; margin: 0 2px; border-radius: 50%; vertical-align: middle; }
</style>
</head>
<body>
<h1>ìŠ¤ì½”ì–´ë³´ë“œ ì…ë ¥ - ë””ë²„ê¹…</h1>
<div class="section team-inputs">
<label>íŒ€ëª…</label>
<input id="team1" placeholder="íŒ€1 ì´ë¦„" type="text"/>
<input id="team2" placeholder="íŒ€2 ì´ë¦„" type="text"/>
</div>
<div class="section">
<label>ì ìˆ˜ ì¡°ì •</label>
<div class="button-group">
<div class="score-controls">
<span class="score1-label score-label">íŒ€1</span>:
          <button id="btn-score1-plus">+</button>
<span id="score1">0</span>
<button id="btn-score1-minus">-</button>
</div>
<span>Â |Â </span>
<div class="score-controls">
<span class="score2-label score-label">íŒ€2</span>:
          <button id="btn-score2-plus">+</button>
<span id="score2">0</span>
<button id="btn-score2-minus">-</button>
</div>
</div>
<button id="reset-score">ì ìˆ˜ ë¦¬ì…‹</button>
</div>
<div class="section">
<label>ë³¼ì¹´ìš´íŠ¸</label>
<div class="button-group">
<span>B:</span><button id="btn-ball-plus">+</button><button id="btn-ball-minus">-</button>
<span>S:</span><button id="btn-strike-plus">+</button><button id="btn-strike-minus">-</button>
<span>O:</span><button id="btn-out-plus">+</button><button id="btn-out-minus">-</button>
</div>
<div id="ball_status">ë³¼: 0</div>
<div id="strike_status">ìŠ¤íŠ¸ë¼ì´í¬: 0</div>
<div id="out_status">ì•„ì›ƒ: </div>
<button id="reset-counts">ì¹´ìš´íŠ¸ ë¦¬ì…‹</button>
</div>
<div class="section">
<label>ì´ë‹</label>
<div class="button-group">
<button id="btn-inning-minus">-</button><span id="inning_status">1íšŒì´ˆ</span><button id="btn-inning-plus">+</button>
</div>
<button id="reset-inning">ì´ë‹ ë¦¬ì…‹</button>
</div>
<div class="section">
<label>ì£¼ë£¨ìƒí™©</label>
<div class="checkbox-group">
<label><input id="base1" type="checkbox"/> 1ë£¨</label>
<label><input id="base2" type="checkbox"/> 2ë£¨</label>
<label><input id="base3" type="checkbox"/> 3ë£¨</label>
</div>
<button id="reset-bases">ì£¼ë£¨ ë¦¬ì…‹</button>
</div>
<script>
  let ws;

  // --- ìƒíƒœ ë³€ìˆ˜ ---
  let ballCount = 0;
  let strikeCount = 0;
  let outCount = 0;
  let inningNum = 1;
  let isTop = true; // true: ì´ˆ, false: ë§

  // --- ì›¹ì†Œì¼“ ì—°ê²° ë° í•¨ìˆ˜ ---
  function connectWebSocket() {
      ws = new WebSocket("ws://" + location.hostname + ":8765");

      ws.onopen = () => {
          console.log("âœ… WebSocket ì—°ê²°ë¨");
          sendInitialState();
      };

      ws.onmessage = (event) => {
          // ì…ë ¥ í˜ì´ì§€ì´ë¯€ë¡œ ìˆ˜ì‹  ë©”ì‹œì§€ ì²˜ë¦¬ ì•ˆ í•¨
      };

      ws.onerror = (error) => {
          console.error("âŒ WebSocket ì˜¤ë¥˜:", error);
      };

      ws.onclose = () => {
          console.log("ğŸ”Œ WebSocket ì—°ê²° ëŠê¹€. 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...");
          setTimeout(connectWebSocket, 5000);
      };
  }

  function send(type, value) {
    if (ws && ws.readyState === WebSocket.OPEN) {
      const data = { type, value };
      console.log("ğŸ“¤ ì „ì†¡:", data);
      ws.send(JSON.stringify(data));
    } else {
      console.warn("WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•„ ì „ì†¡ ì‹¤íŒ¨:", { type, value });
    }
  }

  // --- UI ì—…ë°ì´íŠ¸ ë° ë°ì´í„° ì „ì†¡ í•¨ìˆ˜ ---

  function flashElement(element) {
      if (element) {
          element.classList.add("status-alert");
          setTimeout(() => element.classList.remove("status-alert"), 400);
      }
  }

  function updateTeamLabel() {
    const team1Name = document.getElementById("team1")?.value || "íŒ€1";
    const team2Name = document.getElementById("team2")?.value || "íŒ€2";
    document.querySelectorAll(".score1-label").forEach(el => el.textContent = team1Name);
    document.querySelectorAll(".score2-label").forEach(el => el.textContent = team2Name);
    send("team1", team1Name);
    send("team2", team2Name);
  }

  function adjustScore(teamId, delta) {
    const el = document.getElementById(teamId);
    if (!el) return;
    let current = parseInt(el.textContent || "0", 10);
    const updated = Math.max(0, current + delta);
    el.textContent = updated.toString();
    send(teamId, updated);
  }

  function updateBallDisplay() {
    const el = document.getElementById("ball_status");
    if (el) {
      el.textContent = "ë³¼: " + ballCount;
      flashElement(el);
    }
    send("ball", ballCount);
  }

  function updateStrikeDisplay() {
    const el = document.getElementById('strike_status');
    if (el) {
      el.textContent = 'ìŠ¤íŠ¸ë¼ì´í¬: ' + strikeCount;
      flashElement(el);
    }
    send('strike', strikeCount);
  }

  function updateOutDisplay() {
    const el = document.getElementById('out_status');
    const out1 = document.getElementById('out1');
    const out2 = document.getElementById('out2');
    if (el && out1 && out2) {
      el.ariaLabel = `ì•„ì›ƒ: ${outCount}`;
      out1.classList.toggle('active', outCount >= 1);
      out2.classList.toggle('active', outCount >= 2);
      flashElement(el);
    }
    send('out', outCount);
  }

  // --- ì´ë‹ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€) ---
  function updateInningDisplay() {
    console.log(`updateInningDisplay í˜¸ì¶œë¨: inningNum=${inningNum}, isTop=${isTop}`); // ë¡œê·¸ ì¶”ê°€
    const el = document.getElementById('inning_display');
    const inningString = `${inningNum}íšŒ${isTop ? 'ì´ˆ' : 'ë§'}`;
    if (el) {
      console.log(`ì´ë‹ í‘œì‹œ ì—…ë°ì´íŠ¸: ${inningString}`); // ë¡œê·¸ ì¶”ê°€
      el.textContent = inningString;
      flashElement(el);
    } else {
      console.error("Error: 'inning_display' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); // ì˜¤ë¥˜ ë¡œê·¸ ì¶”ê°€
    }
    send('inning', inningString);
  }

  function updateBaseDisplay(baseId, isChecked) {
      send(baseId, isChecked);
  }

  // --- ì¹´ìš´íŠ¸ ë° ì´ë‹ ë³€ê²½ ë¡œì§ ---

  function resetCounts() {
      ballCount = 0;
      strikeCount = 0;
  }

  function clearBases() {
      document.getElementById('base1').checked = false;
      document.getElementById('base2').checked = false;
      document.getElementById('base3').checked = false;
      updateBaseDisplay('base1', false);
      updateBaseDisplay('base2', false);
      updateBaseDisplay('base3', false);
  }

  function handleStrikeOut() {
      console.log("ì‚¼ì§„!");
      outCount++;
      resetCounts();
      updateOutDisplay();
      updateBallDisplay();
      updateStrikeDisplay();
      checkThreeOuts();
  }

  function handleWalk() {
      console.log("ë³¼ë„·!");
      resetCounts();
      updateBallDisplay();
      updateStrikeDisplay();
  }

  function checkThreeOuts() {
      if (outCount >= 3) {
          console.log("ì“°ë¦¬ ì•„ì›ƒ! ê³µìˆ˜êµëŒ€.");
          changeInning(true); // ê³µìˆ˜êµëŒ€ë¡œ ì¸í•œ ì´ë‹ ë³€ê²½ì„ì„ í‘œì‹œ (true ì „ë‹¬)
          outCount = 0;
          resetCounts();
          clearBases();
          updateOutDisplay();
          updateBallDisplay();
          updateStrikeDisplay();
      }
  }

  // --- ì´ë‹ ë³€ê²½ í•¨ìˆ˜ (ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€, ê³µìˆ˜êµëŒ€ íŒŒë¼ë¯¸í„° ì¶”ê°€) ---
  function changeInning(isTurnChange = false) { // ê³µìˆ˜êµëŒ€ ì—¬ë¶€ íŒŒë¼ë¯¸í„° ì¶”ê°€
      console.log("changeInning í˜¸ì¶œë¨", isTurnChange ? "(ê³µìˆ˜êµëŒ€)" : ""); // ë¡œê·¸ ì¶”ê°€
      if (isTop) { // ì´ˆ -> ë§
          isTop = false;
          console.log("ì´ë‹ ë³€ê²½: ì´ˆ -> ë§");
      } else { // ë§ -> ë‹¤ìŒ íšŒ ì´ˆ
          isTop = true;
          inningNum++;
          console.log(`ì´ë‹ ë³€ê²½: ë§ -> ${inningNum}íšŒ ì´ˆ`);
      }
      // ê³µìˆ˜êµëŒ€ë¡œ ì¸í•œ í˜¸ì¶œ ì‹œì—ëŠ” updateInningDisplayë¥¼ checkThreeOutsì—ì„œ í•˜ë¯€ë¡œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
      if (!isTurnChange) {
          updateInningDisplay();
      }
  }

  function previousInning() {
      console.log("previousInning í˜¸ì¶œë¨"); // ë¡œê·¸ ì¶”ê°€
      if (isTop) { // ì´ˆ -> ì´ì „ íšŒ ë§
          if (inningNum > 1) {
              inningNum--;
              isTop = false;
              console.log(`ì´ë‹ ë³€ê²½: ì´ˆ -> ${inningNum}íšŒ ë§`);
              updateInningDisplay();
          } else {
              console.log("1íšŒì´ˆ ì´ì „ìœ¼ë¡œ ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              return; // ë³€ê²½ ì—†ìŒ
          }
      } else { // ë§ -> í˜„ì¬ íšŒ ì´ˆ
          isTop = true;
          console.log("ì´ë‹ ë³€ê²½: ë§ -> ì´ˆ");
          updateInningDisplay();
      }
  }

  // --- ì´ˆê¸° ìƒíƒœ ì „ì†¡ í•¨ìˆ˜ ---
  function sendInitialState() {
      console.log("ì´ˆê¸° ìƒíƒœ ì „ì†¡ ì¤‘...");
      updateTeamLabel();
      send("score1", parseInt(document.getElementById("score1")?.textContent || "0", 10));
      send("score2", parseInt(document.getElementById("score2")?.textContent || "0", 10));
      send("ball", ballCount);
      send("strike", strikeCount);
      send("out", outCount);
      // ì´ˆê¸° ì´ë‹ ì „ì†¡ ì „ì— updateInningDisplayë¥¼ í˜¸ì¶œí•˜ì—¬ ê°’ ì„¤ì • ë° ì „ì†¡
      updateInningDisplay();
      // send('inning', `${inningNum}íšŒ${isTop ? 'ì´ˆ' : 'ë§'}`); // updateInningDisplayì—ì„œ ì „ì†¡í•˜ë¯€ë¡œ ì¤‘ë³µ
      send("base1", document.getElementById("base1")?.checked || false);
      send("base2", document.getElementById("base2")?.checked || false);
      send("base3", document.getElementById("base3")?.checked || false);
  }


  // --- DOM ë¡œë“œ í›„ ì‹¤í–‰ ---
  window.addEventListener("DOMContentLoaded", () => {
    connectWebSocket(); // ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘

    // ì´ˆê¸° UI ì—…ë°ì´íŠ¸ (0, 1íšŒì´ˆ ë“±)
    updateBallDisplay();
    updateStrikeDisplay();
    updateOutDisplay();
    // updateInningDisplay(); // sendInitialStateì—ì„œ í˜¸ì¶œë¨
    updateTeamLabel();

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---

    // íŒ€ëª…
    document.getElementById("team1")?.addEventListener("input", updateTeamLabel);
    document.getElementById("team2")?.addEventListener("input", updateTeamLabel);

    // ì ìˆ˜
    document.getElementById("btn-score1-plus")?.addEventListener("click", () => adjustScore("score1", 1));
    document.getElementById("btn-score1-minus")?.addEventListener("click", () => adjustScore("score1", -1));
    document.getElementById("btn-score2-plus")?.addEventListener("click", () => adjustScore("score2", 1));
    document.getElementById("btn-score2-minus")?.addEventListener("click", () => adjustScore("score2", -1));
    document.getElementById("reset-score")?.addEventListener("click", () => {
      adjustScore("score1", -parseInt(document.getElementById("score1")?.textContent || "0", 10));
      adjustScore("score2", -parseInt(document.getElementById("score2")?.textContent || "0", 10));
    });

    // ë³¼ì¹´ìš´íŠ¸
    document.getElementById("btn-ball-plus")?.addEventListener("click", () => {
      if (ballCount < 3) {
        ballCount++;
        updateBallDisplay();
      } else {
        ballCount = 4;
        handleWalk();
      }
    });
    document.getElementById("btn-ball-minus")?.addEventListener("click", () => {
      if (ballCount > 0) {
        ballCount--;
        updateBallDisplay();
      }
    });

    // ìŠ¤íŠ¸ë¼ì´í¬ ì¹´ìš´íŠ¸
    document.getElementById("btn-strike-plus")?.addEventListener("click", () => {
        if (strikeCount < 2) {
            strikeCount++;
            updateStrikeDisplay();
        } else {
            strikeCount = 3;
            handleStrikeOut();
        }
    });
    document.getElementById("btn-strike-minus")?.addEventListener("click", () => {
        if (strikeCount > 0) {
            strikeCount--;
            updateStrikeDisplay();
        }
    });

    // ì•„ì›ƒ ì¹´ìš´íŠ¸
    document.getElementById("btn-out-plus")?.addEventListener("click", () => {
        if (outCount < 2) {
            outCount++;
            resetCounts();
            updateOutDisplay();
            updateBallDisplay();
            updateStrikeDisplay();
        } else if (outCount === 2) {
            outCount = 3;
            resetCounts();
            updateBallDisplay();
            updateStrikeDisplay();
            // updateOutDisplay(); // ì–´ì°¨í”¼ checkThreeOutsì—ì„œ ë¦¬ì…‹ í›„ ì—…ë°ì´íŠ¸í•¨
            checkThreeOuts(); // ì“°ë¦¬ì•„ì›ƒ ì²˜ë¦¬ (ì—¬ê¸°ì„œ ìµœì¢… ì•„ì›ƒ í‘œì‹œ ì—…ë°ì´íŠ¸)
        }
    });
    document.getElementById("btn-out-minus")?.addEventListener("click", () => {
        if (outCount > 0) {
            outCount--;
            updateOutDisplay();
        }
    });

    document.getElementById("reset-counts")?.addEventListener("click", () => {
        outCount = 0;
        resetCounts(); // B/S ë¦¬ì…‹
        updateOutDisplay();
        updateBallDisplay();
        updateStrikeDisplay();
    });

    // --- ì´ë‹ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ (changeInning/previousInning ì§ì ‘ í˜¸ì¶œ) ---
    document.getElementById("btn-inning-plus")?.addEventListener("click", () => changeInning()); // isTurnChange=false ê¸°ë³¸ê°’
    document.getElementById("btn-inning-minus")?.addEventListener("click", previousInning);

    document.getElementById("reset-inning")?.addEventListener("click", () => {
        inningNum = 1;
        isTop = true;
        console.log("ì´ë‹ ë¦¬ì…‹ë¨: 1íšŒ ì´ˆ"); // ë¡œê·¸ ì¶”ê°€
        updateInningDisplay();
    });

    // ì£¼ë£¨ìƒí™©
    document.getElementById("base1")?.addEventListener("change", (e) => updateBaseDisplay("base1", e.target.checked));
    document.getElementById("base2")?.addEventListener("change", (e) => updateBaseDisplay("base2", e.target.checked));
    document.getElementById("base3")?.addEventListener("change", (e) => updateBaseDisplay("base3", e.target.checked));
    document.getElementById("reset-bases")?.addEventListener("click", clearBases);

  }); // DOMContentLoaded ë
</script>
</html>
